name: Build and Release AdByBy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        arch: [mipsel]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y wget xz-utils make gcc
    
    - name: Download Toolchain
      run: |
        TOOLCHAIN_URL="https://github.com/tekintian/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
        wget -O toolchain.tar.xz "$TOOLCHAIN_URL"
        mkdir -p toolchain
        tar -xf toolchain.tar.xz -C toolchain
        echo "=== Toolchain directory structure ==="
        ls -la toolchain/
    
    - name: Setup Toolchain Environment
      run: |
        # 设置工具链环境变量（工具链直接包含bin目录）
        TOOLCHAIN_DIR="$PWD/toolchain"
        BIN_DIR="$TOOLCHAIN_DIR/bin"
        PREFIX="mipsel-linux-musl"
        
        export CROSS_COMPILE="${PREFIX}-"
        export TARGET_CC="${PREFIX}-gcc"
        export TARGET_CROSS="${PREFIX}-"
        export PATH="${BIN_DIR}:$PATH"
        
        # 写入到GitHub环境
        echo "TOOLCHAIN_DIR=${TOOLCHAIN_DIR}" >> $GITHUB_ENV
        echo "CROSS_COMPILE=${CROSS_COMPILE}" >> $GITHUB_ENV
        echo "TARGET_CC=${TARGET_CC}" >> $GITHUB_ENV
        echo "TARGET_CROSS=${TARGET_CROSS}" >> $GITHUB_ENV
        echo "BIN_DIR=${BIN_DIR}" >> $GITHUB_ENV
        echo "${BIN_DIR}" >> $GITHUB_PATH
        
        # 验证编译器
        if command -v "${CROSS_COMPILE}gcc" >/dev/null 2>&1; then
          echo "✓ Compiler found: ${CROSS_COMPILE}gcc"
          "${CROSS_COMPILE}gcc" --version
        else
          echo "✗ Compiler not found: ${CROSS_COMPILE}gcc"
          echo "Looking for: ${CROSS_COMPILE}gcc"
          echo "Available files:"
          ls -la "${BIN_DIR}/" | grep gcc || echo "Bin directory not found"
          exit 1
        fi
    
    - name: Compile AdByBy
      run: |
        # 显示编译环境信息
        echo "=== Build Environment ==="
        echo "CROSS_COMPILE: $CROSS_COMPILE"
        echo "TARGET_CC: $TARGET_CC"
        echo "TARGET_CROSS: $TARGET_CROSS"
        echo "PATH: $PATH"
        which "${CROSS_COMPILE}gcc" || echo "Compiler not in PATH"
        
        # 显示make将要使用的变量
        echo "=== Make Variables ==="
        make -pn | grep -E '^(CC|CROSS_COMPILE|STRIP|TARGET_CC|TARGET_CROSS)' | head -10
        
        # 清理并编译（确保环境变量传递给make）
        make clean
        make info
        make compile CROSS_COMPILE="$CROSS_COMPILE" TARGET_CC="$TARGET_CC" TARGET_CROSS="$TARGET_CROSS"
        
        # 检查编译结果
        if [ -f "adbyby" ]; then
          echo "✓ 编译成功"
          file adbyby
          ls -la adbyby
        elif [ -f "src/adbyby" ]; then
          echo "✓ 在 src 目录找到可执行文件"
          cp src/adbyby adbyby
          file adbyby
          ls -la adbyby
        else
          echo "✗ 编译失败，查看详细错误信息"
          echo "=== 查找可能的可执行文件 ==="
          find . -name "adbyby" -type f 2>/dev/null
          echo "=== 查看src目录内容 ==="
          ls -la src/
          echo "=== 尝试使用src目录Makefile直接编译 ==="
          cd src
          make clean
          make CC="${CROSS_COMPILE}gcc" STRIP="${CROSS_COMPILE}strip" CROSS_COMPILE="$CROSS_COMPILE"
          if [ -f "adbyby" ]; then
            cp adbyby ../
            echo "✓ 使用src目录编译成功"
            file adbyby
          else
            echo "✗ src目录编译也失败"
            exit 1
          fi
          cd ..
        fi
    
    - name: Prepare Package
      run: |
        mkdir -p release_package/adbyby-open
        mkdir -p release_package/adbyby-open/usr/share/adbyby
        mkdir -p release_package/adbyby-open/usr/share/adbyby/data
        mkdir -p release_package/adbyby-open/usr/share/adbyby/doc
        mkdir -p release_package/adbyby-open/usr/bin
        mkdir -p release_package/adbyby-open/etc_ro
        
        # 复制可执行文件到 /usr/share/adbyby/（根据 Makefile install-romfs 目标）
        cp adbyby release_package/adbyby-open/usr/share/adbyby/ || {
          echo "尝试从 src 目录复制"
          cp src/adbyby release_package/adbyby-open/usr/share/adbyby/ || exit 1
        }
        
        # 根据 Makefile 中的 install-romfs 目标复制配置文件
        cp share/adblack.conf release_package/adbyby-open/usr/share/adbyby/
        cp share/adesc.conf release_package/adbyby-open/usr/share/adbyby/
        cp share/adhook.ini release_package/adbyby-open/usr/share/adbyby/
        cp share/adhost.conf release_package/adbyby-open/usr/share/adbyby/
        cp share/blockip.conf release_package/adbyby-open/usr/share/adbyby/
        cp share/rules.txt release_package/adbyby-open/usr/share/adbyby/
        cp share/update.info release_package/adbyby-open/usr/share/adbyby/
        cp share/user.action release_package/adbyby-open/usr/share/adbyby/
        cp share/dnsmasq.adblock release_package/adbyby-open/usr/share/adbyby/
        cp share/dnsmasq.ads release_package/adbyby-open/usr/share/adbyby/
        cp share/dnsmasq.esc release_package/adbyby-open/usr/share/adbyby/
        cp share/firewall.include release_package/adbyby-open/usr/share/adbyby/
        
        # 复制脚本文件到 /usr/share/adbyby/（带执行权限）
        cp share/adblock.sh release_package/adbyby-open/usr/share/adbyby/
        cp share/adbyby.sh release_package/adbyby-open/usr/share/adbyby/
        cp share/adbybyfirst.sh release_package/adbyby-open/usr/share/adbyby/
        cp share/adbybyupdate.sh release_package/adbyby-open/usr/share/adbyby/
        cp share/admem.sh release_package/adbyby-open/usr/share/adbyby/
        cp share/adupdate.sh release_package/adbyby-open/usr/share/adbyby/
        
        # 复制 data 目录文件到 /usr/share/adbyby/data/
        cp share/data/lazy.txt release_package/adbyby-open/usr/share/adbyby/data/
        cp share/data/rules.txt release_package/adbyby-open/usr/share/adbyby/data/
        cp share/data/user.txt release_package/adbyby-open/usr/share/adbyby/data/
        cp share/data/video.txt release_package/adbyby-open/usr/share/adbyby/data/
        
        # 复制 doc 目录文件到 /usr/share/adbyby/doc/
        cp share/doc/hidecss.js release_package/adbyby-open/usr/share/adbyby/doc/
        
        # 复制自定义配置脚本到 /etc_ro/
        cp adbyby_rules.sh release_package/adbyby-open/etc_ro/
        cp adbyby_adblack.sh release_package/adbyby-open/etc_ro/
        cp adbyby_adesc.sh release_package/adbyby-open/etc_ro/
        cp adbyby_adhost.sh release_package/adbyby-open/etc_ro/
        cp adbyby_host.sh release_package/adbyby-open/etc_ro/
        cp adbyby_blockip.sh release_package/adbyby-open/etc_ro/
        
        # 复制主脚本到 /usr/bin/
        cp adbyby.sh release_package/adbyby-open/usr/bin/adbyby.sh
        
        # 复制安装脚本和说明文档（便于用户使用）
        cp install.sh release_package/adbyby-open/
        cp README.md release_package/adbyby-open/
        cp QUICKSTART.md release_package/adbyby-open/
        
        # 创建版本信息文件
        echo "Build Information:" > release_package/adbyby-open/build_info.txt
        echo "Build Date: $(date)" >> release_package/adbyby-open/build_info.txt
        echo "Git Commit: $(git rev-parse HEAD)" >> release_package/adbyby-open/build_info.txt
        echo "Git Branch: $(git rev-parse --abbrev-ref HEAD)" >> release_package/adbyby-open/build_info.txt
        echo "Architecture: ${{ matrix.arch }}" >> release_package/adbyby-open/build_info.txt
        echo "Toolchain: https://github.com/tekintian/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" >> release_package/adbyby-open/build_info.txt
        
        # 设置执行权限
        chmod +x release_package/adbyby-open/usr/share/adbyby/adbyby
        chmod +x release_package/adbyby-open/usr/share/adbyby/*.sh
        chmod +x release_package/adbyby-open/usr/bin/adbyby.sh
        chmod +x release_package/adbyby-open/etc_ro/*.sh
        chmod +x release_package/adbyby-open/install.sh
        
        # 创建安装说明
        printf '%s\n' 'AdByBy-Open 安装说明' '===================' '' '目录结构：' '- usr/share/adbyby/      # 主程序和配置文件' '- usr/share/adbyby/data/  # 数据文件' '- usr/share/adbyby/doc/   # 文档文件' '- usr/bin/               # 可执行脚本' '- etc_ro/                # 配置脚本' '' '安装步骤：' '1. 将 usr/share/adbyby/ 目录复制到路由器的 /usr/share/adbyby/' '2. 将 usr/bin/adbyby.sh 复制到路由器的 /usr/bin/adbyby.sh' '3. 将 etc_ro/ 下的脚本复制到路由器的 /etc_ro/' '4. 设置执行权限：chmod +x /usr/share/adbyby/adbyby /usr/share/adbyby/*.sh /usr/bin/adbyby.sh /etc_ro/*.sh' '5. 运行安装脚本：./install.sh' '' '快速安装：' '运行根目录下的 install.sh 脚本即可自动安装。' > release_package/adbyby-open/INSTALLATION.txt
        
        # 显示包内容
        echo "=== Package Contents ==="
        find release_package/adbyby-open -type f | sort
    
    - name: Create Archive
      run: |
        cd release_package
        tar -czf ../adbyby-open-${{ matrix.arch }}-${{ github.run_number }}.tar.gz adbyby-open/
        cd ..
        
        # 显示压缩包信息
        ls -la *.tar.gz
        tar -tzf adbyby-open-${{ matrix.arch }}-${{ github.run_number }}.tar.gz | head -20
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: adbyby-open-${{ matrix.arch }}-${{ github.run_number }}
        path: adbyby-open-${{ matrix.arch }}-${{ github.run_number }}.tar.gz
        retention-days: 30
    
    - name: Build Info
      run: |
        echo "=== Build completed successfully ==="
        echo "Artifact: adbyby-open-${{ matrix.arch }}-${{ github.run_number }}.tar.gz"
        echo "Download from GitHub Actions artifacts section"