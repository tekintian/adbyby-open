name: Test Toolchain Download

on:
  workflow_dispatch:
  pull_request:

jobs:
  test-toolchain:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download and Test Toolchain
      run: |
        echo "=== Downloading toolchain ==="
        TOOLCHAIN_URL="https://github.com/tekintian/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
        wget -O toolchain.tar.xz "$TOOLCHAIN_URL"
        
        echo "=== Extracting toolchain ==="
        mkdir -p toolchain
        tar -xf toolchain.tar.xz -C toolchain
        
        echo "=== Toolchain directory structure ==="
        find toolchain -type d | head -10
        find toolchain -type f -name "*gcc*" | head -10
        
        echo "=== Setup toolchain environment ==="
        TOOLCHAIN_DIR="$PWD/toolchain"
        BIN_DIR="$TOOLCHAIN_DIR/bin"
        PREFIX="mipsel-linux-musl"
        
        export CROSS_COMPILE="${PREFIX}-"
        export TARGET_CC="${PREFIX}-gcc"
        export TARGET_CROSS="${PREFIX}-"
        export PATH="${BIN_DIR}:$PATH"
        
        echo "Using PREFIX: $PREFIX"
        echo "Using BIN_DIR: $BIN_DIR"
        
        # 验证编译器
        if command -v "${CROSS_COMPILE}gcc" >/dev/null 2>&1; then
          echo "✓ Compiler found: ${CROSS_COMPILE}gcc"
          "${CROSS_COMPILE}gcc" --version
          
          echo "=== Testing simple compilation ==="
          echo "int main(){return 0;}" > test.c
          "${CROSS_COMPILE}gcc" -o test test.c
          if [ -f "test" ]; then
            echo "✓ Simple compilation successful"
            file test
            rm -f test test.c
          else
            echo "✗ Simple compilation failed"
            exit 1
          fi
        else
          echo "✗ Compiler not found: ${CROSS_COMPILE}gcc"
          echo "Looking for: ${CROSS_COMPILE}gcc"
          echo "Available files in bin directory:"
          ls -la "${BIN_DIR}/" 2>/dev/null || echo "Bin directory not found"
          exit 1
        fi