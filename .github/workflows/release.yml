name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Environment
      run: sudo apt-get update && sudo apt-get install -y wget xz-utils make gcc
    
    - name: Download Toolchain
      run: |
        TOOLCHAIN_URL="https://github.com/tekintian/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
        wget -O toolchain.tar.xz "$TOOLCHAIN_URL"
        mkdir -p toolchain
        tar -xf toolchain.tar.xz -C toolchain --strip-components=1
    
    - name: Setup Toolchain Environment
      run: |
        echo "TOOLCHAIN_DIR=$PWD/toolchain" >> $GITHUB_ENV
        echo "CROSS_COMPILE=$PWD/toolchain/bin/mipsel-linux-musl-" >> $GITHUB_ENV
        echo "$PWD/toolchain/bin" >> $GITHUB_PATH
    
    - name: Build Release Package
      run: |
        make clean
        make compile
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ ! -f "adbyby" ] && [ -f "src/adbyby" ]; then
          cp src/adbyby adbyby
        fi
        
        if [ ! -f "adbyby" ]; then
          echo "ç¼–è¯‘å¤±è´¥ï¼Œæ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          exit 1
        fi
        
        # åˆ›å»ºå‘å¸ƒåŒ…
        mkdir -p release_package
        
        # å¤åˆ¶æ‰€æœ‰å¿…è¦æ–‡ä»¶
        cp adbyby release_package/
        cp *.sh release_package/ 2>/dev/null || true
        cp *.conf release_package/ 2>/dev/null || true
        cp -r share release_package/
        cp install.sh release_package/ 2>/dev/null || true
        cp README.md release_package/ 2>/dev/null || true
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "AdByBy-Open Release" > release_package/VERSION.txt
        echo "Version: ${{ github.ref_name }}" >> release_package/VERSION.txt
        echo "Build Date: $(date)" >> release_package/VERSION.txt
        echo "Git Commit: ${{ github.sha }}" >> release_package/VERSION.txt
        echo "Architecture: mipsel" >> release_package/VERSION.txt
    
    - name: Create Archive
      run: |
        cd release_package
        tar -czf ../adbyby-open-${{ github.ref_name }}-mipsel.tar.gz *
        cd ..
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        sha256sum *.tar.gz > checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: AdByBy-Open ${{ github.ref_name }}
        body: |
          ## AdByBy-Open Release ${{ github.ref_name }}
          
          ğŸš€ **æ–°ç‰ˆæœ¬å‘å¸ƒï¼**
          
          **ä¸‹è½½æ–‡ä»¶ï¼š**
          - `adbyby-open-${{ github.ref_name }}-mipsel.tar.gz` - ä¸»ç¨‹åºåŒ…
          - `checksums.txt` - æ–‡ä»¶æ ¡éªŒå’Œ
          
          **å®‰è£…æ–¹æ³•ï¼š**
          1. ä¸‹è½½ `adbyby-open-${{ github.ref_name }}-mipsel.tar.gz`
          2. ä¸Šä¼ åˆ°è·¯ç”±å™¨å¹¶è§£å‹
          3. æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶åˆ°ç›¸åº”ç›®å½•
          
          **æ›´æ–°å†…å®¹ï¼š**
          ${{ github.event.head_commit.message }}
          
          **æ„å»ºä¿¡æ¯ï¼š**
          - ç‰ˆæœ¬ï¼š${{ github.ref_name }}
          - æ¶æ„ï¼šMIPSEL (Padavan å›ºä»¶)
          - å·¥å…·é“¾ï¼šmipsel-linux-musl
        files: |
          *.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}