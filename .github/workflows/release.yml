name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Environment
      run: sudo apt-get update && sudo apt-get install -y wget xz-utils make gcc
    
    - name: Download Toolchain
      run: |
        TOOLCHAIN_URL="https://github.com/tekintian/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
        wget -O toolchain.tar.xz "$TOOLCHAIN_URL"
        mkdir -p toolchain
        tar -xf toolchain.tar.xz -C toolchain
        echo "=== Toolchain directory structure ==="
        ls -la toolchain/
    
    - name: Setup Toolchain Environment
      run: |
        # è®¾ç½®å·¥å…·é“¾ç¯å¢ƒå˜é‡ï¼ˆå·¥å…·é“¾ç›´æ¥åŒ…å«binç›®å½•ï¼‰
        TOOLCHAIN_DIR="$PWD/toolchain"
        BIN_DIR="$TOOLCHAIN_DIR/bin"
        PREFIX="mipsel-linux-musl"
        
        export CROSS_COMPILE="${PREFIX}-"
        export TARGET_CC="${PREFIX}-gcc"
        export TARGET_CROSS="${PREFIX}-"
        export PATH="${BIN_DIR}:$PATH"
        
        # å†™å…¥åˆ°GitHubç¯å¢ƒ
        echo "TOOLCHAIN_DIR=${TOOLCHAIN_DIR}" >> $GITHUB_ENV
        echo "CROSS_COMPILE=${CROSS_COMPILE}" >> $GITHUB_ENV
        echo "TARGET_CC=${TARGET_CC}" >> $GITHUB_ENV
        echo "TARGET_CROSS=${TARGET_CROSS}" >> $GITHUB_ENV
        echo "BIN_DIR=${BIN_DIR}" >> $GITHUB_ENV
        echo "${BIN_DIR}" >> $GITHUB_PATH
        
        # éªŒè¯ç¼–è¯‘å™¨
        if command -v "${CROSS_COMPILE}gcc" >/dev/null 2>&1; then
          echo "âœ“ Compiler found: ${CROSS_COMPILE}gcc"
          "${CROSS_COMPILE}gcc" --version
        else
          echo "âœ— Compiler not found: ${CROSS_COMPILE}gcc"
          echo "Looking for: ${CROSS_COMPILE}gcc"
          echo "Available files:"
          ls -la "${BIN_DIR}/" | grep gcc || echo "Bin directory not found"
          exit 1
        fi
    
    - name: Build Release Package
      run: |
        # æ˜¾ç¤ºç¼–è¯‘ç¯å¢ƒä¿¡æ¯
        echo "=== Build Environment ==="
        echo "CROSS_COMPILE: $CROSS_COMPILE"
        echo "TARGET_CC: $TARGET_CC"
        echo "TARGET_CROSS: $TARGET_CROSS"
        echo "PATH: $PATH"
        which "${CROSS_COMPILE}gcc" || echo "Compiler not in PATH"
        
        # æ¸…ç†å¹¶ç¼–è¯‘ï¼ˆç¡®ä¿ç¯å¢ƒå˜é‡ä¼ é€’ç»™makeï¼‰
        make clean
        make compile CROSS_COMPILE="$CROSS_COMPILE" TARGET_CC="$TARGET_CC" TARGET_CROSS="$TARGET_CROSS"
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -f "adbyby" ]; then
          echo "âœ“ ç¼–è¯‘æˆåŠŸ"
          file adbyby
        elif [ -f "src/adbyby" ]; then
          echo "âœ“ åœ¨ src ç›®å½•æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          cp src/adbyby adbyby
          file adbyby
        else
          echo "âœ— ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨srcç›®å½•Makefileç›´æ¥ç¼–è¯‘"
          cd src
          make clean
          make CC="${CROSS_COMPILE}gcc" STRIP="${CROSS_COMPILE}strip" CROSS_COMPILE="$CROSS_COMPILE"
          if [ -f "adbyby" ]; then
            cp adbyby ../
            echo "âœ“ ä½¿ç”¨srcç›®å½•ç¼–è¯‘æˆåŠŸ"
            file adbyby
          else
            echo "âœ— ç¼–è¯‘å®Œå…¨å¤±è´¥"
            exit 1
          fi
          cd ..
        fi
        
        # åˆ›å»ºå‘å¸ƒåŒ…ï¼ˆæŒ‰ç…§ Makefile ä¸­çš„ romfs ç»“æ„ï¼‰
        mkdir -p release_package/usr/share/adbyby
        mkdir -p release_package/usr/share/adbyby/data
        mkdir -p release_package/usr/share/adbyby/doc
        mkdir -p release_package/usr/bin
        mkdir -p release_package/etc_ro
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ° /usr/share/adbyby/
        cp adbyby release_package/usr/share/adbyby/ || {
          echo "å°è¯•ä» src ç›®å½•å¤åˆ¶"
          cp src/adbyby release_package/usr/share/adbyby/ || exit 1
        }
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶ï¼ˆæ ¹æ® Makefile install-romfs ç›®æ ‡ï¼‰
        cp share/adblack.conf release_package/usr/share/adbyby/
        cp share/adesc.conf release_package/usr/share/adbyby/
        cp share/adhook.ini release_package/usr/share/adbyby/
        cp share/adhost.conf release_package/usr/share/adbyby/
        cp share/blockip.conf release_package/usr/share/adbyby/
        cp share/rules.txt release_package/usr/share/adbyby/
        cp share/update.info release_package/usr/share/adbyby/
        cp share/user.action release_package/usr/share/adbyby/
        cp share/dnsmasq.adblock release_package/usr/share/adbyby/
        cp share/dnsmasq.ads release_package/usr/share/adbyby/
        cp share/dnsmasq.esc release_package/usr/share/adbyby/
        cp share/firewall.include release_package/usr/share/adbyby/
        
        # å¤åˆ¶è„šæœ¬æ–‡ä»¶ï¼ˆå¸¦æ‰§è¡Œæƒé™ï¼‰
        cp share/adblock.sh release_package/usr/share/adbyby/
        cp share/adbyby.sh release_package/usr/share/adbyby/
        cp share/adbybyfirst.sh release_package/usr/share/adbyby/
        cp share/adbybyupdate.sh release_package/usr/share/adbyby/
        cp share/admem.sh release_package/usr/share/adbyby/
        cp share/adupdate.sh release_package/usr/share/adbyby/
        
        # å¤åˆ¶ data ç›®å½•æ–‡ä»¶
        cp share/data/lazy.txt release_package/usr/share/adbyby/data/
        cp share/data/rules.txt release_package/usr/share/adbyby/data/
        cp share/data/user.txt release_package/usr/share/adbyby/data/
        cp share/data/video.txt release_package/usr/share/adbyby/data/
        
        # å¤åˆ¶ doc ç›®å½•æ–‡ä»¶
        cp share/doc/hidecss.js release_package/usr/share/adbyby/doc/
        
        # å¤åˆ¶è‡ªå®šä¹‰é…ç½®è„šæœ¬åˆ° /etc_ro/
        cp adbyby_rules.sh release_package/etc_ro/
        cp adbyby_adblack.sh release_package/etc_ro/
        cp adbyby_adesc.sh release_package/etc_ro/
        cp adbyby_adhost.sh release_package/etc_ro/
        cp adbyby_host.sh release_package/etc_ro/
        cp adbyby_blockip.sh release_package/etc_ro/
        
        # å¤åˆ¶ä¸»è„šæœ¬åˆ° /usr/bin/
        cp adbyby.sh release_package/usr/bin/adbyby.sh
        
        # å¤åˆ¶å®‰è£…è„šæœ¬å’Œè¯´æ˜æ–‡æ¡£
        cp install.sh release_package/
        cp README.md release_package/
        cp QUICKSTART.md release_package/
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "AdByBy-Open Release" > release_package/VERSION.txt
        echo "Version: ${{ github.ref_name }}" >> release_package/VERSION.txt
        echo "Build Date: $(date)" >> release_package/VERSION.txt
        echo "Git Commit: ${{ github.sha }}" >> release_package/VERSION.txt
        echo "Architecture: mipsel" >> release_package/VERSION.txt
        echo "Toolchain: https://github.com/tekintian/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" >> release_package/VERSION.txt
        
        # è®¾ç½®æ‰§è¡Œæƒé™
        chmod +x release_package/usr/share/adbyby/adbyby
        chmod +x release_package/usr/share/adbyby/*.sh
        chmod +x release_package/usr/bin/adbyby.sh
        chmod +x release_package/etc_ro/*.sh
        chmod +x release_package/install.sh
        
        # åˆ›å»ºå®‰è£…è¯´æ˜
        printf '%s\n' 'AdByBy-Open å®‰è£…è¯´æ˜' '===================' '' 'ç›®å½•ç»“æ„ï¼š' '- usr/share/adbyby/      # ä¸»ç¨‹åºå’Œé…ç½®æ–‡ä»¶' '- usr/share/adbyby/data/  # æ•°æ®æ–‡ä»¶' '- usr/share/adbyby/doc/   # æ–‡æ¡£æ–‡ä»¶' '- usr/bin/               # å¯æ‰§è¡Œè„šæœ¬' '- etc_ro/                # é…ç½®è„šæœ¬' '' 'å®‰è£…æ­¥éª¤ï¼š' '1. å°† usr/share/adbyby/ ç›®å½•å¤åˆ¶åˆ°è·¯ç”±å™¨çš„ /usr/share/adbyby/' '2. å°† usr/bin/adbyby.sh å¤åˆ¶åˆ°è·¯ç”±å™¨çš„ /usr/bin/adbyby.sh' '3. å°† etc_ro/ ä¸‹çš„è„šæœ¬å¤åˆ¶åˆ°è·¯ç”±å™¨çš„ /etc_ro/' '4. è®¾ç½®æ‰§è¡Œæƒé™ï¼šchmod +x /usr/share/adbyby/adbyby /usr/share/adbyby/*.sh /usr/bin/adbyby.sh /etc_ro/*.sh' '5. è¿è¡Œå®‰è£…è„šæœ¬ï¼š./install.sh' '' 'å¿«é€Ÿå®‰è£…ï¼š' 'è¿è¡Œæ ¹ç›®å½•ä¸‹çš„ install.sh è„šæœ¬å³å¯è‡ªåŠ¨å®‰è£…ã€‚' '' "ç‰ˆæœ¬ä¿¡æ¯ï¼š${{ github.ref_name }}" > release_package/INSTALLATION.txt
    
    - name: Create Archive
      run: |
        cd release_package
        tar -czf ../adbyby-open-${{ github.ref_name }}-mipsel.tar.gz *
        cd ..
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        sha256sum *.tar.gz > checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: AdByBy-Open ${{ github.ref_name }}
        body: |
          ## AdByBy-Open Release ${{ github.ref_name }}
          
          ğŸš€ **æ–°ç‰ˆæœ¬å‘å¸ƒï¼**
          
          **ä¸‹è½½æ–‡ä»¶ï¼š**
          - `adbyby-open-${{ github.ref_name }}-mipsel.tar.gz` - ä¸»ç¨‹åºåŒ…
          - `checksums.txt` - æ–‡ä»¶æ ¡éªŒå’Œ
          
          **å®‰è£…æ–¹æ³•ï¼š**
          1. ä¸‹è½½ `adbyby-open-${{ github.ref_name }}-mipsel.tar.gz`
          2. ä¸Šä¼ åˆ°è·¯ç”±å™¨å¹¶è§£å‹
          3. æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶åˆ°ç›¸åº”ç›®å½•
          
          **æ›´æ–°å†…å®¹ï¼š**
          ${{ github.event.head_commit.message }}
          
          **æ„å»ºä¿¡æ¯ï¼š**
          - ç‰ˆæœ¬ï¼š${{ github.ref_name }}
          - æ¶æ„ï¼šMIPSEL (Padavan å›ºä»¶)
          - å·¥å…·é“¾ï¼šmipsel-linux-musl
        files: |
          *.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}