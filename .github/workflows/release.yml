name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Environment
      run: sudo apt-get update && sudo apt-get install -y wget xz-utils make gcc
    
    - name: Download Toolchain
      run: |
        TOOLCHAIN_URL="https://github.com/tekintian/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
        wget -O toolchain.tar.xz "$TOOLCHAIN_URL"
        mkdir -p toolchain
        tar -xf toolchain.tar.xz -C toolchain
        echo "=== Toolchain directory structure ==="
        ls -la toolchain/
    
    - name: Setup Toolchain Environment
      run: |
        # è®¾ç½®å·¥å…·é“¾ç¯å¢ƒå˜é‡ï¼ˆå·¥å…·é“¾ç›´æ¥åŒ…å«binç›®å½•ï¼‰
        TOOLCHAIN_DIR="$PWD/toolchain"
        BIN_DIR="$TOOLCHAIN_DIR/bin"
        PREFIX="mipsel-linux-musl"
        
        export CROSS_COMPILE="${PREFIX}-"
        export TARGET_CC="${PREFIX}-gcc"
        export TARGET_CROSS="${PREFIX}-"
        export PATH="${BIN_DIR}:$PATH"
        
        # å†™å…¥åˆ°GitHubç¯å¢ƒ
        echo "TOOLCHAIN_DIR=${TOOLCHAIN_DIR}" >> $GITHUB_ENV
        echo "CROSS_COMPILE=${CROSS_COMPILE}" >> $GITHUB_ENV
        echo "TARGET_CC=${TARGET_CC}" >> $GITHUB_ENV
        echo "TARGET_CROSS=${TARGET_CROSS}" >> $GITHUB_ENV
        echo "BIN_DIR=${BIN_DIR}" >> $GITHUB_ENV
        echo "${BIN_DIR}" >> $GITHUB_PATH
        
        # éªŒè¯ç¼–è¯‘å™¨
        if command -v "${CROSS_COMPILE}gcc" >/dev/null 2>&1; then
          echo "âœ“ Compiler found: ${CROSS_COMPILE}gcc"
          "${CROSS_COMPILE}gcc" --version
        else
          echo "âœ— Compiler not found: ${CROSS_COMPILE}gcc"
          echo "Looking for: ${CROSS_COMPILE}gcc"
          echo "Available files:"
          ls -la "${BIN_DIR}/" | grep gcc || echo "Bin directory not found"
          exit 1
        fi
    
    - name: Build Release Package
      run: |
        # æ˜¾ç¤ºç¼–è¯‘ç¯å¢ƒä¿¡æ¯
        echo "=== Build Environment ==="
        echo "CROSS_COMPILE: $CROSS_COMPILE"
        echo "TARGET_CC: $TARGET_CC"
        echo "TARGET_CROSS: $TARGET_CROSS"
        echo "PATH: $PATH"
        which "${CROSS_COMPILE}gcc" || echo "Compiler not in PATH"
        
        # æ¸…ç†å¹¶ç¼–è¯‘ï¼ˆç¡®ä¿ç¯å¢ƒå˜é‡ä¼ é€’ç»™makeï¼‰
        make clean
        make compile CROSS_COMPILE="$CROSS_COMPILE" TARGET_CC="$TARGET_CC" TARGET_CROSS="$TARGET_CROSS"
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ -f "adbyby" ]; then
          echo "âœ“ ç¼–è¯‘æˆåŠŸ"
          file adbyby
        elif [ -f "src/adbyby" ]; then
          echo "âœ“ åœ¨ src ç›®å½•æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          cp src/adbyby adbyby
          file adbyby
        else
          echo "âœ— ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨srcç›®å½•Makefileç›´æ¥ç¼–è¯‘"
          cd src
          make clean
          make CC="${CROSS_COMPILE}gcc" STRIP="${CROSS_COMPILE}strip" CROSS_COMPILE="$CROSS_COMPILE"
          if [ -f "adbyby" ]; then
            cp adbyby ../
            echo "âœ“ ä½¿ç”¨srcç›®å½•ç¼–è¯‘æˆåŠŸ"
            file adbyby
          else
            echo "âœ— ç¼–è¯‘å®Œå…¨å¤±è´¥"
            exit 1
          fi
          cd ..
        fi
        
        # åˆ›å»ºå‘å¸ƒåŒ…
        mkdir -p release_package
        
        # å¤åˆ¶æ‰€æœ‰å¿…è¦æ–‡ä»¶
        cp adbyby release_package/
        cp *.sh release_package/ 2>/dev/null || true
        cp *.conf release_package/ 2>/dev/null || true
        cp -r share release_package/
        cp install.sh release_package/ 2>/dev/null || true
        cp README.md release_package/ 2>/dev/null || true
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "AdByBy-Open Release" > release_package/VERSION.txt
        echo "Version: ${{ github.ref_name }}" >> release_package/VERSION.txt
        echo "Build Date: $(date)" >> release_package/VERSION.txt
        echo "Git Commit: ${{ github.sha }}" >> release_package/VERSION.txt
        echo "Architecture: mipsel" >> release_package/VERSION.txt
    
    - name: Create Archive
      run: |
        cd release_package
        tar -czf ../adbyby-open-${{ github.ref_name }}-mipsel.tar.gz *
        cd ..
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        sha256sum *.tar.gz > checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: AdByBy-Open ${{ github.ref_name }}
        body: |
          ## AdByBy-Open Release ${{ github.ref_name }}
          
          ğŸš€ **æ–°ç‰ˆæœ¬å‘å¸ƒï¼**
          
          **ä¸‹è½½æ–‡ä»¶ï¼š**
          - `adbyby-open-${{ github.ref_name }}-mipsel.tar.gz` - ä¸»ç¨‹åºåŒ…
          - `checksums.txt` - æ–‡ä»¶æ ¡éªŒå’Œ
          
          **å®‰è£…æ–¹æ³•ï¼š**
          1. ä¸‹è½½ `adbyby-open-${{ github.ref_name }}-mipsel.tar.gz`
          2. ä¸Šä¼ åˆ°è·¯ç”±å™¨å¹¶è§£å‹
          3. æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶åˆ°ç›¸åº”ç›®å½•
          
          **æ›´æ–°å†…å®¹ï¼š**
          ${{ github.event.head_commit.message }}
          
          **æ„å»ºä¿¡æ¯ï¼š**
          - ç‰ˆæœ¬ï¼š${{ github.ref_name }}
          - æ¶æ„ï¼šMIPSEL (Padavan å›ºä»¶)
          - å·¥å…·é“¾ï¼šmipsel-linux-musl
        files: |
          *.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}